<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced QR Code Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --orange-primary: #ff6b35;
            --orange-glow: #ff8c42;
            --orange-light: #ffab73;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --border-color: #333333;
            --shadow-orange: 0 10px 30px rgba(255, 107, 53, 0.3);
            --shadow-dark: 0 8px 25px rgba(0, 0, 0, 0.4);
            --transition: all 0.3s ease;
        }

        [data-theme="light"] {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --shadow-dark: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 0 20px 40px;
            line-height: 1.6;
            transition: var(--transition);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            padding-top: 20px;
        }

        .main-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 30px;
            height: fit-content;
        }

        .preview-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 30px;
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            position: relative;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 50px;
            height: 3px;
            background: linear-gradient(90deg, var(--orange-primary), var(--orange-glow));
            border-radius: 2px;
        }

        .header-buttons {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            width: 50px;
            height: 50px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-primary);
        }

        .header-btn:hover {
            border-color: var(--orange-primary);
            background: rgba(255, 107, 53, 0.1);
            transform: translateY(-2px);
        }

        .theme-toggle::after { content: 'üåô'; }
        [data-theme="light"] .theme-toggle::after { content: '‚òÄÔ∏è'; }
        .source-btn::after { content: '<>'; font-weight: 600; font-size: 16px; }
        .history-btn::after { content: 'üìã'; }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--orange-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            font-size: 14px;
            color: var(--text-primary);
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            outline: none;
            transition: var(--transition);
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--orange-primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .color-input-group {
            position: relative;
        }

        .color-input {
            width: 100%;
            height: 50px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .color-input:hover {
            border-color: var(--orange-primary);
        }

        .gradient-controls {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--orange-primary);
        }

        .btn {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--orange-primary), var(--orange-glow));
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-orange);
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--orange-primary);
            background: rgba(255, 107, 53, 0.1);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .logo-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .logo-upload input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .logo-preview {
            width: 100px;
            height: 100px;
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            background: var(--bg-primary);
        }

        .logo-preview img {
            max-width: 90px;
            max-height: 90px;
            border-radius: 5px;
        }

        .qr-preview {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
        }

        .qr-preview:empty::before {
            content: 'QR code preview will appear here';
            color: var(--text-secondary);
            font-size: 14px;
        }

        .qr-preview canvas, .qr-preview svg {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .download-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .share-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: white;
            font-size: 18px;
            transition: var(--transition);
        }

        .share-btn:hover {
            transform: translateY(-2px);
        }

        .share-twitter { background: #1da1f2; }
        .share-facebook { background: #4267b2; }
        .share-whatsapp { background: #25d366; }
        .share-telegram { background: #0088cc; }

        .history-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            padding: 20px;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .history-panel.open {
            right: 0;
        }

        .history-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: var(--transition);
        }

        .history-item:hover {
            border-color: var(--orange-primary);
        }

        .history-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .history-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        .style-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .style-option {
            aspect-ratio: 1;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            text-align: center;
        }

        .style-option.selected {
            border-color: var(--orange-primary);
            background: rgba(255, 107, 53, 0.1);
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .preview-panel {
                position: static;
            }
            
            .history-panel {
                width: 100vw;
                right: -100vw;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .main-panel, .preview-panel {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .download-options {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Panel -->
        <div class="main-panel">
            <div class="header">
                <h1>QR Code Generator</h1>
                <div class="header-buttons">
                    <button class="header-btn history-btn" onclick="toggleHistory()" title="History"></button>
                    <button class="header-btn source-btn" onclick="showSourceCode()" title="Source Code"></button>
                    <button class="header-btn theme-toggle" onclick="toggleTheme()" title="Theme"></button>
                </div>
            </div>

            <!-- QR Type Selection -->
            <div class="section">
                <div class="section-title">QR Code Type</div>
                <div class="form-group">
                    <select class="form-select" id="qrType" onchange="changeQRType()">
                        <option value="text">Text/URL</option>
                        <option value="wifi">WiFi</option>
                        <option value="vcard">Business Card (vCard)</option>
                        <option value="sms">SMS</option>
                        <option value="email">Email</option>
                    </select>
                </div>

                <!-- Text/URL -->
                <div id="textInputs" class="qr-inputs">
                    <div class="form-group">
                        <label class="form-label">Text or URL</label>
                        <textarea class="form-textarea" id="textContent" placeholder="Enter your text or URL" oninput="generatePreview()"></textarea>
                    </div>
                </div>

                <!-- WiFi -->
                <div id="wifiInputs" class="qr-inputs" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Network Name (SSID)</label>
                        <input type="text" class="form-input" id="wifiSSID" placeholder="WiFi network name" oninput="generatePreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="text" class="form-input" id="wifiPassword" placeholder="WiFi password" oninput="generatePreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Security</label>
                        <select class="form-select" id="wifiSecurity" onchange="generatePreview()">
                            <option value="WPA">WPA/WPA2</option>
                            <option value="WEP">WEP</option>
                            <option value="nopass">No Password</option>
                        </select>
                    </div>
                </div>

                <!-- vCard -->
                <div id="vcardInputs" class="qr-inputs" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-input" id="vcardFirstName" placeholder="First name" oninput="generatePreview()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-input" id="vcardLastName" placeholder="Last name" oninput="generatePreview()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company</label>
                        <input type="text" class="form-input" id="vcardOrg" placeholder="Company name" oninput="generatePreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="vcardPhone" placeholder="Phone number" oninput="generatePreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="vcardEmail" placeholder="Email address" oninput="generatePreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="url" class="form-input" id="vcardUrl" placeholder="Website URL" oninput="generatePreview()">
                    </div>
                </div>

                <!-- SMS -->
                <div id="smsInputs" class="qr-inputs" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="smsPhone" placeholder="Phone number" oninput="generatePreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Message</label>
                        <textarea class="form-textarea" id="smsMessage" placeholder="SMS message" oninput="generatePreview()"></textarea>
                    </div>
                </div>

                <!-- Email -->
                <div id="emailInputs" class="qr-inputs" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" id="emailAddress" placeholder="Email address" oninput="generatePreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subject</label>
                        <input type="text" class="form-input" id="emailSubject" placeholder="Email subject" oninput="generatePreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Message</label>
                        <textarea class="form-textarea" id="emailBody" placeholder="Email message" oninput="generatePreview()"></textarea>
                    </div>
                </div>
            </div>

            <!-- Visual Settings -->
            <div class="section">
                <div class="section-title">Visual Settings</div>
                
                <!-- Colors -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Foreground Color</label>
                        <div class="color-input-group">
                            <input type="color" class="color-input" id="foregroundColor" value="#000000" onchange="generatePreview()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Background Color</label>
                        <div class="color-input-group">
                            <input type="color" class="color-input" id="backgroundColor" value="#ffffff" onchange="generatePreview()">
                        </div>
                    </div>
                </div>

                <!-- Gradient -->
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" class="checkbox" id="useGradient" onchange="toggleGradient()">
                        <label class="form-label">Use Gradient</label>
                    </div>
                    <div id="gradientControls" style="display: none;">
                        <div class="gradient-controls">
                            <div class="form-group">
                                <input type="color" class="color-input" id="gradientColor1" value="#ff6b35" onchange="generatePreview()">
                            </div>
                            <div class="form-group">
                                <input type="color" class="color-input" id="gradientColor2" value="#ff8c42" onchange="generatePreview()">
                            </div>
                            <div class="form-group">
                                <select class="form-select" id="gradientDirection" onchange="generatePreview()">
                                    <option value="0">Horizontal</option>
                                    <option value="90">Vertical</option>
                                    <option value="45">Diagonal</option>
                                    <option value="135">Reverse Diagonal</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logo -->
                <div class="form-group">
                    <label class="form-label">Add Logo</label>
                    <div class="logo-upload">
                        <input type="file" accept="image/*" onchange="handleLogoUpload(event)">
                        <button type="button" class="btn btn-secondary" style="width: 100%;">Choose Logo</button>
                    </div>
                    <div class="logo-preview" id="logoPreview">
                        <span style="color: var(--text-secondary);">Logo preview</span>
                    </div>
                </div>

                <!-- Style Options -->
                <div class="form-group">
                    <label class="form-label">QR Style</label>
                    <div class="style-options">
                        <div class="style-option selected" data-style="square" onclick="selectStyle('square')">Square</div>
                        <div class="style-option" data-style="circle" onclick="selectStyle('circle')">Round</div>
                        <div class="style-option" data-style="rounded" onclick="selectStyle('rounded')">Soft</div>
                    </div>
                </div>

                <!-- Size -->
                <div class="form-group">
                    <label class="form-label">Size: <span id="sizeValue">300</span>px</label>
                    <input type="range" class="form-input" id="qrSize" min="200" max="800" value="300" oninput="updateSize(); generatePreview()">
                </div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="preview-panel">
            <div class="section-title">Preview</div>
            <div class="qr-preview" id="qrPreview"></div>
            
            <div class="download-options">
                <button class="btn" onclick="downloadQR('png')">Download PNG</button>
                <button class="btn" onclick="downloadQR('jpg')">Download JPG</button>
                <button class="btn" onclick="downloadQR('svg')">Download SVG</button>
                <button class="btn" onclick="downloadQR('pdf')">Download PDF</button>
            </div>

            <div class="section-title">Share</div>
            <div class="share-buttons">
                <a href="#" class="share-btn share-twitter" onclick="shareToTwitter()" title="Twitter">üê¶</a>
                <a href="#" class="share-btn share-facebook" onclick="shareToFacebook()" title="Facebook">üìò</a>
                <a href="#" class="share-btn share-whatsapp" onclick="shareToWhatsApp()" title="WhatsApp">üí¨</a>
                <a href="#" class="share-btn share-telegram" onclick="shareToTelegram()" title="Telegram">‚úàÔ∏è</a>
            </div>
        </div>
    </div>

    <!-- History Panel -->
    <div class="history-overlay" onclick="closeHistory()"></div>
    <div class="history-panel" id="historyPanel">
        <h2>QR Code History</h2>
        <div id="historyList"></div>
        <button class="btn btn-secondary" onclick="clearHistory()" style="width: 100%; margin-top: 20px;">Clear History</button>
    </div>

    <script>
        let currentQRData = '';
        let currentLogoData = null;
        let qrHistory = JSON.parse(localStorage.getItem('qrHistory') || '[]');

        // Theme functions
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? null : 'light';
            
            if (newTheme) {
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            } else {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'dark');
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        }

        // QR type change
        function changeQRType() {
            const qrType = document.getElementById('qrType').value;
            document.querySelectorAll('.qr-inputs').forEach(input => {
                input.style.display = 'none';
            });
            document.getElementById(qrType + 'Inputs').style.display = 'block';
            generatePreview();
        }

        // Generate QR content
        function generateQRContent() {
            const qrType = document.getElementById('qrType').value;
            
            switch(qrType) {
                case 'text':
                    return document.getElementById('textContent').value;
                
                case 'wifi':
                    const ssid = document.getElementById('wifiSSID').value;
                    const password = document.getElementById('wifiPassword').value;
                    const security = document.getElementById('wifiSecurity').value;
                    return `WIFI:T:${security};S:${ssid};P:${password};;`;
                
                case 'vcard':
                    const firstName = document.getElementById('vcardFirstName').value;
                    const lastName = document.getElementById('vcardLastName').value;
                    const org = document.getElementById('vcardOrg').value;
                    const phone = document.getElementById('vcardPhone').value;
                    const email = document.getElementById('vcardEmail').value;
                    const url = document.getElementById('vcardUrl').value;
                    
                    return `BEGIN:VCARD
VERSION:3.0
FN:${firstName} ${lastName}
ORG:${org}
TEL:${phone}
EMAIL:${email}
URL:${url}
END:VCARD`;
                
                case 'sms':
                    const smsPhone = document.getElementById('smsPhone').value;
                    const smsMessage = document.getElementById('smsMessage').value;
                    return `sms:${smsPhone}?body=${encodeURIComponent(smsMessage)}`;
                
                case 'email':
                    const emailAddress = document.getElementById('emailAddress').value;
                    const emailSubject = document.getElementById('emailSubject').value;
                    const emailBody = document.getElementById('emailBody').value;
                    return `mailto:${emailAddress}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
                
                default:
                    return '';
            }
        }

        // Real-time preview
        function generatePreview() {
            const content = generateQRContent();
            if (!content.trim()) return;
            
            currentQRData = content;
            const container = document.getElementById('qrPreview');
            container.innerHTML = '';
            
            try {
                const qr = qrcode(0, 'M');
                qr.addData(content);
                qr.make();
                
                const size = parseInt(document.getElementById('qrSize').value);
                const foregroundColor = document.getElementById('foregroundColor').value;
                const backgroundColor = document.getElementById('backgroundColor').value;
                const useGradient = document.getElementById('useGradient').checked;
                
                if (useGradient) {
                    const svg = createGradientQR(qr, size);
                    container.innerHTML = svg;
                } else {
                    const canvas = createQRCanvas(qr, size, foregroundColor, backgroundColor);
                    container.appendChild(canvas);
                }
                
                if (currentLogoData) {
                    addLogoToQR();
                }
            } catch (error) {
                console.error('QR code generation error:', error);
            }
        }

        // Create QR canvas
        function createQRCanvas(qr, size, foregroundColor, backgroundColor) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const modules = qr.getModuleCount();
            const cellSize = size / modules;
            
            canvas.width = size;
            canvas.height = size;
            
            // Background
            ctx.fillStyle = backgroundColor;
            ctx.fillRect(0, 0, size, size);
            
            // QR modules
            ctx.fillStyle = foregroundColor;
            const style = document.querySelector('.style-option.selected').dataset.style;
            
            for (let row = 0; row < modules; row++) {
                for (let col = 0; col < modules; col++) {
                    if (qr.isDark(row, col)) {
                        const x = col * cellSize;
                        const y = row * cellSize;
                        
                        if (style === 'circle') {
                            ctx.beginPath();
                            ctx.roundRect(x, y, cellSize, cellSize, cellSize/4);
                            ctx.fill();
                        } else {
                            ctx.fillRect(x, y, cellSize, cellSize);
                        }
                    }
                }
            }
            
            return canvas;
        }

        // Create gradient SVG QR code
        function createGradientQR(qr, size) {
            const modules = qr.getModuleCount();
            const cellSize = size / modules;
            const gradientColor1 = document.getElementById('gradientColor1').value;
            const gradientColor2 = document.getElementById('gradientColor2').value;
            const gradientDirection = document.getElementById('gradientDirection').value;
            
            let gradientDef = '';
            switch(gradientDirection) {
                case '0': gradientDef = 'x1="0%" y1="0%" x2="100%" y2="0%"'; break;
                case '90': gradientDef = 'x1="0%" y1="0%" x2="0%" y2="100%"'; break;
                case '45': gradientDef = 'x1="0%" y1="0%" x2="100%" y2="100%"'; break;
                case '135': gradientDef = 'x1="100%" y1="0%" x2="0%" y2="100%"'; break;
            }
            
            let svg = `<svg width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="qrGradient" ${gradientDef}>
                        <stop offset="0%" style="stop-color:${gradientColor1}"/>
                        <stop offset="100%" style="stop-color:${gradientColor2}"/>
                    </linearGradient>
                </defs>
                <rect width="${size}" height="${size}" fill="${document.getElementById('backgroundColor').value}"/>`;
            
            const style = document.querySelector('.style-option.selected').dataset.style;
            
            for (let row = 0; row < modules; row++) {
                for (let col = 0; col < modules; col++) {
                    if (qr.isDark(row, col)) {
                        const x = col * cellSize;
                        const y = row * cellSize;
                        
                        if (style === 'circle') {
                            svg += `<circle cx="${x + cellSize/2}" cy="${y + cellSize/2}" r="${cellSize/2}" fill="url(#qrGradient)"/>`;
                        } else if (style === 'rounded') {
                            svg += `<rect x="${x}" y="${y}" width="${cellSize}" height="${cellSize}" rx="${cellSize/4}" fill="url(#qrGradient)"/>`;
                        } else {
                            svg += `<rect x="${x}" y="${y}" width="${cellSize}" height="${cellSize}" fill="url(#qrGradient)"/>`;
                        }
                    }
                }
            }
            
            svg += '</svg>';
            return svg;
        }

        // Logo upload
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentLogoData = e.target.result;
                    const preview = document.getElementById('logoPreview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="Logo">`;
                    generatePreview();
                };
                reader.readAsDataURL(file);
            }
        }

        // Add logo to QR
        function addLogoToQR() {
            const container = document.getElementById('qrPreview');
            const qrElement = container.querySelector('canvas, svg');
            if (!qrElement || !currentLogoData) return;
            
            const logo = new Image();
            logo.onload = function() {
                if (qrElement.tagName === 'CANVAS') {
                    const ctx = qrElement.getContext('2d');
                    const logoSize = qrElement.width * 0.2;
                    const x = (qrElement.width - logoSize) / 2;
                    const y = (qrElement.height - logoSize) / 2;
                    
                    // Logo background
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(x - 5, y - 5, logoSize + 10, logoSize + 10);
                    
                    // Logo
                    ctx.drawImage(logo, x, y, logoSize, logoSize);
                }
            };
            logo.src = currentLogoData;
        }

        // Style selection
        function selectStyle(style) {
            document.querySelectorAll('.style-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`[data-style="${style}"]`).classList.add('selected');
            generatePreview();
        }

        // Gradient toggle
        function toggleGradient() {
            const useGradient = document.getElementById('useGradient').checked;
            document.getElementById('gradientControls').style.display = useGradient ? 'block' : 'none';
            generatePreview();
        }

        // Size update
        function updateSize() {
            document.getElementById('sizeValue').textContent = document.getElementById('qrSize').value;
        }

        // Download functions
        function downloadQR(format) {
            if (!currentQRData) return;
            
            const container = document.getElementById('qrPreview');
            const qrElement = container.querySelector('canvas, svg');
            if (!qrElement) return;
            
            // Add to history
            addToHistory();
            
            const filename = `qr-code.${format}`;
            
            if (format === 'svg') {
                downloadSVG(qrElement, filename);
            } else if (format === 'pdf') {
                downloadPDF(qrElement, filename);
            } else {
                downloadCanvas(qrElement, format, filename);
            }
        }

        function downloadCanvas(element, format, filename) {
            let canvas;
            
            if (element.tagName === 'SVG') {
                // Convert SVG to canvas
                canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const svgData = new XMLSerializer().serializeToString(element);
                const img = new Image();
                
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = canvas.toDataURL(`image/${format}`, 0.9);
                    link.click();
                };
                
                img.src = 'data:image/svg+xml;base64,' + btoa(svgData);
                return;
            } else {
                canvas = element;
            }
            
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL(`image/${format}`, 0.9);
            link.click();
        }

        function downloadSVG(element, filename) {
            let svgData;
            
            if (element.tagName === 'SVG') {
                svgData = new XMLSerializer().serializeToString(element);
            } else {
                // Convert canvas to SVG (simple method)
                const size = element.width;
                svgData = `<svg width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg">
                    <image href="${element.toDataURL()}" width="${size}" height="${size}"/>
                </svg>`;
            }
            
            const blob = new Blob([svgData], {type: 'image/svg+xml'});
            const link = document.createElement('a');
            link.download = filename;
            link.href = URL.createObjectURL(blob);
            link.click();
        }

        function downloadPDF(element, filename) {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            if (element.tagName === 'CANVAS') {
                const imgData = element.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 10, 10, 100, 100);
            } else {
                // For SVG
                const svgData = new XMLSerializer().serializeToString(element);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    const imgData = canvas.toDataURL('image/png');
                    pdf.addImage(imgData, 'PNG', 10, 10, 100, 100);
                    pdf.save(filename);
                };
                
                img.src = 'data:image/svg+xml;base64,' + btoa(svgData);
                return;
            }
            
            pdf.save(filename);
        }

        // Share functions
        function shareToTwitter() {
            const text = encodeURIComponent('My QR code is ready! #QRCode');
            window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
        }

        function shareToFacebook() {
            window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(window.location.href), '_blank');
        }

        function shareToWhatsApp() {
            const text = encodeURIComponent('My QR code is ready!');
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        function shareToTelegram() {
            const text = encodeURIComponent('My QR code is ready!');
            window.open(`https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${text}`, '_blank');
        }

        // History functions
        function addToHistory() {
            const historyItem = {
                id: Date.now(),
                type: document.getElementById('qrType').value,
                content: currentQRData,
                date: new Date().toLocaleDateString(),
                settings: {
                    foregroundColor: document.getElementById('foregroundColor').value,
                    backgroundColor: document.getElementById('backgroundColor').value,
                    size: document.getElementById('qrSize').value,
                    useGradient: document.getElementById('useGradient').checked,
                    style: document.querySelector('.style-option.selected').dataset.style
                }
            };
            
            qrHistory.unshift(historyItem);
            if (qrHistory.length > 20) {
                qrHistory = qrHistory.slice(0, 20);
            }
            
            localStorage.setItem('qrHistory', JSON.stringify(qrHistory));
            updateHistoryPanel();
        }

        function updateHistoryPanel() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            qrHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 5px;">${getTypeLabel(item.type)}</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">${item.date}</div>
                    <div style="font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${item.content.substring(0, 50)}${item.content.length > 50 ? '...' : ''}
                    </div>
                `;
                
                historyItem.onclick = () => loadFromHistory(item);
                historyList.appendChild(historyItem);
            });
        }

        function getTypeLabel(type) {
            const labels = {
                'text': 'Text/URL',
                'wifi': 'WiFi',
                'vcard': 'Business Card',
                'sms': 'SMS',
                'email': 'Email'
            };
            return labels[type] || type;
        }

        function loadFromHistory(item) {
            // Load settings
            document.getElementById('qrType').value = item.type;
            document.getElementById('foregroundColor').value = item.settings.foregroundColor;
            document.getElementById('backgroundColor').value = item.settings.backgroundColor;
            document.getElementById('qrSize').value = item.settings.size;
            document.getElementById('useGradient').checked = item.settings.useGradient;
            
            // Style selection
            document.querySelectorAll('.style-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`[data-style="${item.settings.style}"]`).classList.add('selected');
            
            // Change type and load content
            changeQRType();
            
            // Parse content and fill form fields
            if (item.type === 'text') {
                document.getElementById('textContent').value = item.content;
            } else if (item.type === 'wifi') {
                const wifiData = parseWiFiData(item.content);
                document.getElementById('wifiSSID').value = wifiData.ssid || '';
                document.getElementById('wifiPassword').value = wifiData.password || '';
                document.getElementById('wifiSecurity').value = wifiData.security || 'WPA';
            }
            // Parse functions for other types can be added here
            
            updateSize();
            toggleGradient();
            generatePreview();
            closeHistory();
        }

        function parseWiFiData(wifiString) {
            const result = {};
            const matches = wifiString.match(/WIFI:T:([^;]*);S:([^;]*);P:([^;]*);/);
            if (matches) {
                result.security = matches[1];
                result.ssid = matches[2];
                result.password = matches[3];
            }
            return result;
        }

        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            const overlay = document.querySelector('.history-overlay');
            
            if (panel.classList.contains('open')) {
                closeHistory();
            } else {
                updateHistoryPanel();
                panel.classList.add('open');
                overlay.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeHistory() {
            const panel = document.getElementById('historyPanel');
            const overlay = document.querySelector('.history-overlay');
            
            panel.classList.remove('open');
            overlay.classList.remove('show');
            document.body.style.overflow = '';
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all history?')) {
                qrHistory = [];
                localStorage.setItem('qrHistory', JSON.stringify(qrHistory));
                updateHistoryPanel();
            }
        }

        // Show source code
        function showSourceCode() {
            window.open('https://www.github.com/hudulovhamzat0/qr', '_blank');
        }

        // Page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            updateHistoryPanel();
            
            // Canvas roundRect polyfill (for older browsers)
            if (!CanvasRenderingContext2D.prototype.roundRect) {
                CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
                    if (w < 2 * r) r = w / 2;
                    if (h < 2 * r) r = h / 2;
                    this.beginPath();
                    this.moveTo(x + r, y);
                    this.arcTo(x + w, y, x + w, y + h, r);
                    this.arcTo(x + w, y + h, x, y + h, r);
                    this.arcTo(x, y + h, x, y, r);
                    this.arcTo(x, y, x + w, y, r);
                    this.closePath();
                    return this;
                };
            }
        });
    </script>
</body>
</html>